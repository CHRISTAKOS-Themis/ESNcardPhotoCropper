<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Face Cropper (Review & Edit)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        body { font-family: sans-serif; background: #222; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: #333; padding: 20px; border-radius: 8px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* The Layout */
        .workspace { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        /* The Editor Area */
        .img-container { 
            width: 500px; 
            height: 400px; 
            background: #000; 
            overflow: hidden; /* Important for Cropper.js */
        }
        
        /* The Preview Area */
        .preview-container { 
            text-align: center; 
        }
        .preview-box {
            width: 135px; /* 27mm * 5 (Scale) */
            height: 185px; /* 37mm * 5 */
            border: 2px solid white;
            overflow: hidden;
            background: #444;
            display: inline-block;
        }

        /* Controls */
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.secondary { background: #555; }
        
        #status { margin-bottom: 15px; font-weight: bold; color: #aaa; text-align: center; }
        
        /* Hide the file input but keep functionality */
        input[type="file"] { display: none; }
        .upload-btn { background: #28a745; display: inline-block; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center">Interactive Smart Cropper</h2>
    <div id="status">Loading AI Models...</div>

    <div class="workspace">
        <div>
            <div class="img-container">
                <img id="image" src="" style="display:block; max-width: 100%;">
            </div>
        </div>

        <div class="preview-container">
            <p>Result Preview</p>
            <div class="preview-box"></div> </div>
    </div>

    <div class="controls">
        <label class="upload-btn" id="uploadLabel">
            Upload Photo
            <input type="file" id="imageInput" accept="image/*" disabled>
        </label>
        <button id="downloadBtn" disabled>Download Crop</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const TARGET_WIDTH_MM = 27;
    const TARGET_HEIGHT_MM = 37;
    const ASPECT_RATIO = TARGET_WIDTH_MM / TARGET_HEIGHT_MM; // 0.729
    const ZOOM_FACTOR = 2.2; 
    
    // NOTE: Change this to './' if you host models locally
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models'; 

    let cropper = null;
    const imageElement = document.getElementById('image');
    const statusText = document.getElementById('status');
    const inputElement = document.getElementById('imageInput');
    const downloadBtn = document.getElementById('downloadBtn');

    // 1. Initialize AI
    async function init() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            statusText.innerText = "Ready. Upload a photo.";
            inputElement.disabled = false;
        } catch (e) {
            statusText.innerText = "Error loading models.";
            console.error(e);
        }
    }
    init();

    // 2. Handle Upload
    inputElement.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        
        // Reset Logic
        if (cropper) cropper.destroy();
        imageElement.src = url;
        downloadBtn.disabled = true;
        statusText.innerText = "Detecting face...";

        // Wait for image to load in DOM
        imageElement.onload = async () => {
            // A. Start Cropper (User can see image immediately)
            cropper = new Cropper(imageElement, {
                aspectRatio: ASPECT_RATIO,
                viewMode: 1, // Restrict crop box to canvas
                preview: '.preview-box', // Connects to the side preview
                autoCrop: true, // Start with a default box (we will move it shortly)
                ready() {
                    downloadBtn.disabled = false;
                }
            });

            // B. Run AI Detection
            await detectAndAutoCrop();
        };
    });

    // 3. The "Smart" Logic applied to Cropper.js
    async function detectAndAutoCrop() {
        // We detect on the original DOM image (Cropper.js wraps it, but it's still there)
        const detections = await faceapi.detectAllFaces(imageElement, new faceapi.TinyFaceDetectorOptions());

        if (!detections.length) {
            statusText.innerText = "No face detected. Manual crop enabled.";
            return;
        }

        const face = detections[0].box;
        
        // --- CALCULATE CROP BOX (Top-Anchored Logic) ---
        // 1. Get Natural Image Dimensions (Real pixel size)
        const imgW = imageElement.naturalWidth;
        const imgH = imageElement.naturalHeight;

        // 2. Calculate Ideal Box
        const faceH = face.height;
        const idealH = faceH * ZOOM_FACTOR;
        const idealW = idealH * ASPECT_RATIO;
        
        // 3. Calculate Center & Anchor Shift
        const faceCenterX = face.x + (face.width / 2);
        const faceCenterY = face.y + (face.height / 2);
        
        // Shift UP by 12% to capture hair
        const shiftY = idealH * 0.12; 
        const anchorY = faceCenterY - shiftY;

        // 4. Calculate Left/Top
        let left = faceCenterX - (idealW / 2);
        let top = anchorY - (idealH / 2);
        let width = idealW;
        let height = idealH;

        // 5. Bounds Check (Simple clamp)
        // Note: Cropper.js 'viewMode:1' handles the strict containment, 
        // but providing good initial coordinates helps.
        if (top < 0) top = 0;
        if (left < 0) left = 0;
        
        // --- APPLY TO CROPPER ---
        // setData expects natural pixel coordinates
        cropper.setData({
            x: left,
            y: top,
            width: width,
            height: height
        });

        statusText.innerText = "Face detected! Adjust if needed.";
    }

// 4. Download Logic (Original Resolution)
    downloadBtn.addEventListener('click', () => {
        if (!cropper) return;

        // getCroppedCanvas() without 'width' or 'height' automatically 
        // grabs the exact pixels from the original image.
        const canvas = cropper.getCroppedCanvas({
            fillColor: '#fff', // Fills background with white if crop goes off-edge
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        // Convert to Blob (better for large high-res files)
        canvas.toBlob((blob) => {
            const link = document.createElement('a');
            // Name the file
            link.download = 'cropped_photo_original_size.jpg'; 
            link.href = URL.createObjectURL(blob);
            link.click();
            
            // Clean up memory
            setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        }, 'image/jpeg', 1.0); // 1.0 = Maximum Quality (No compression)
    });
</script>

</body>
</html>
