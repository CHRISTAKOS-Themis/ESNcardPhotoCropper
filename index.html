<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESNcard Photo Tool</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* --- ESN COLOR PALETTE --- */
        :root {
            --esn-cyan: #00aeef;
            --esn-magenta: #ec008c;
            --esn-green: #7ac143;
            --esn-dark-blue: #2e3192;
            --esn-orange: #f47b20;
            --esn-white: #ffffff;
            --esn-bg: #f4f7f6;
        }

        /* --- MOBILE LAYOUT --- */
        body { 
            font-family: "Lato", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--esn-bg); 
            color: var(--esn-dark-blue); 
            margin: 0;
            display: flex; 
            flex-direction: column; 
            
            /* FIX: Dynamic Viewport Height for Mobile Bars */
            min-height: 100dvh;
            height: 100dvh; 
            
            overflow: hidden; 
        }

        /* Header Area */
        .header {
            background: var(--esn-white);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
            text-align: center;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--esn-cyan); letter-spacing: -0.5px; }
        .subtitle { font-size: 12px; color: #888; margin-top: 4px; }

        /* Instructions Banner */
        .instructions {
            background: var(--esn-dark-blue);
            color: white;
            padding: 8px;
            font-size: 13px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .step { display: flex; align-items: center; gap: 4px; opacity: 0.9; }
        .step span { background: rgba(255,255,255,0.2); width: 16px; height: 16px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        /* Workspace (Image Area) */
        .workspace { 
            flex: 1; 
            position: relative; 
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* FIX: Hide image initially to prevent flicker */
        .img-container { 
            width: 100%; 
            height: 100%; 
            max-height: 80vh;
            opacity: 0; 
            transition: opacity 0.3s ease-in-out; 
        }
        .img-container.loaded {
            opacity: 1; 
        }
        
        img { max-width: 100%; display: block; }

        /* Status Overlay */
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-weight: 600;
            color: var(--esn-dark-blue);
            pointer-events: none;
            z-index: 20;
            display: none;
            white-space: nowrap;
        }
        #status.visible { display: block; }

        /* Controls Area */
        .controls { 
            background: var(--esn-white); 
            padding: 15px 20px; 
            padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
            display: flex; 
            gap: 12px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        button, .upload-btn { 
            flex: 1;
            padding: 14px; 
            font-size: 16px; 
            font-weight: 700;
            border-radius: 8px; 
            text-align: center;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:active, .upload-btn:active { transform: scale(0.98); }

        .upload-btn { background: var(--esn-cyan); color: white; }
        
        #downloadBtn { background: var(--esn-magenta); color: white; }
        #downloadBtn:disabled { background: #ddd; color: #999; cursor: default; }

        input[type="file"] { display: none; }
        
        .cropper-view-box {
            outline: 2px solid var(--esn-cyan);
            box-shadow: 0 0 0 1px white;
        }
        .cropper-point { background-color: var(--esn-cyan); }
    </style>
</head>
<body>

<div class="header">
    <h1>ESNcard Photo Cropper</h1>
    <div class="subtitle">Official Ratio 27mm x 37mm</div>
</div>

<div class="instructions">
    <div class="step"><span>1</span> Upload</div>
    <div class="step"><span>2</span> Adjust</div>
    <div class="step"><span>3</span> Save</div>
</div>

<div class="workspace">
    <div class="img-container">
        <img id="image" src="">
    </div>
    <div id="status">Loading AI...</div>
</div>

<div class="controls">
    <label class="upload-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload
        <input type="file" id="imageInput" accept="image/*" disabled>
    </label>
    
    <button id="downloadBtn" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download
    </button>
</div>

<script>
    // --- CONFIGURATION ---
    const TARGET_WIDTH_MM = 27;
    const TARGET_HEIGHT_MM = 37;
    const ASPECT_RATIO = TARGET_WIDTH_MM / TARGET_HEIGHT_MM; 
    const ZOOM_FACTOR = 2.2; 
    
    // NOTE: If your models are in the repo root, use './'
    // If you are testing locally without downloading models, use this URL:
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models'; 

    let cropper = null;
    const imageElement = document.getElementById('image');
    const container = document.querySelector('.img-container');
    const statusBox = document.getElementById('status');
    const inputElement = document.getElementById('imageInput');
    const downloadBtn = document.getElementById('downloadBtn');

    // Status Helpers
    function showStatus(msg, autoHide = false) {
        statusBox.innerText = msg;
        statusBox.classList.add('visible');
        if(autoHide) setTimeout(() => statusBox.classList.remove('visible'), 2000);
    }
    function hideStatus() {
        statusBox.classList.remove('visible');
    }

    // 1. Initialize AI
    async function init() {
        showStatus("Loading AI...");
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            hideStatus();
            inputElement.disabled = false;
        } catch (e) {
            showStatus("Error loading AI models.");
            console.error(e);
        }
    }
    init();

    // 2. Handle Upload (Fixed for Flickering & Detection)
    inputElement.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        
        // Reset State
        if (cropper) cropper.destroy();
        downloadBtn.disabled = true;
        container.classList.remove('loaded'); // Hide UI to prevent flicker
        showStatus("Analyzing...");

        // A. Create Hidden Image for Detection (Bypasses CSS scaling)
        const tempImg = new Image();
        tempImg.src = url;
        
        tempImg.onload = async () => {
            try {
                // B. Run AI on full-resolution image
                const detections = await faceapi.detectAllFaces(tempImg, new faceapi.TinyFaceDetectorOptions());
                
                let initialCropData = null;

                // C. Calculate Crop Box
                if (detections.length > 0) {
                    const face = detections[0].box;
                    const imgW = tempImg.naturalWidth;
                    const imgH = tempImg.naturalHeight;

                    const faceH = face.height;
                    const idealH = faceH * ZOOM_FACTOR;
                    const idealW = idealH * ASPECT_RATIO;
                    
                    // Anchor Logic (Shift Up)
                    const faceCenterX = face.x + (face.width / 2);
                    const faceCenterY = face.y + (face.height / 2);
                    const shiftY = idealH * 0.12; 
                    const anchorY = faceCenterY - shiftY;

                    let left = faceCenterX - (idealW / 2);
                    let top = anchorY - (idealH / 2);

                    // Bounds Check
                    if (top < 0) top = 0;
                    if (left < 0) left = 0;
                    if (left + idealW > imgW) left = imgW - idealW;
                    if (top + idealH > imgH) top = imgH - idealH;

                    initialCropData = {
                        x: left,
                        y: top,
                        width: idealW,
                        height: idealH
                    };
                    showStatus("Face aligned!", true);
                } else {
                    showStatus("No face detected. Crop manually.", true);
                }

                // D. Initialize Cropper on Real Image
                imageElement.src = url;
                
                // Wait for Cropper to be ready
                cropper = new Cropper(imageElement, {
                    aspectRatio: ASPECT_RATIO,
                    viewMode: 1, 
                    dragMode: 'move',
                    autoCropArea: 0.8,
                    guides: true,
                    center: true,
                    highlight: false,
                    background: false,
                    data: initialCropData, // Apply calculated box immediately
                    ready() {
                        container.classList.add('loaded'); // Fade in smoothly
                        downloadBtn.disabled = false;
                    }
                });

            } catch (err) {
                console.error(err);
                showStatus("Error processing image.");
                container.classList.add('loaded');
            }
        };
    });

    // 3. Download Logic (Max Quality)
    downloadBtn.addEventListener('click', () => {
        if (!cropper) return;
        
        showStatus("Processing...");
        
        setTimeout(() => {
            const canvas = cropper.getCroppedCanvas({
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });

            canvas.toBlob((blob) => {
                const link = document.createElement('a');
                link.download = 'ESN_photo_cropped.jpg';
                link.href = URL.createObjectURL(blob);
                link.click();
                showStatus("Downloaded!", true);
            }, 'image/jpeg', 1.0);
        }, 100);
    });
</script>

</body>
</html>
